= Day Trader

The heritage Stock trading application based on J2EE.

== Pre-requisites

* https://try.openshift.com[OpenShift 4 Cluster]
* https://www.redhat.com/en/resources/amq-streams-datasheet[Red Hat AMQ Streams]

== Prepare Cluster

Ensure the following operator is installed in cluster:

- https://www.redhat.com/en/blog/getting-started-red-hat-amq-streams-operator[Red Hat AMQ Streams]

*NOTE*: In OpenShift the operators can be installed via Operator Hub integration from Administrator console.

*NOTE*: Operator needs to be installed in all namespaces.

== Clone these sources

[source,bash]
----
git clone -b sko-demo https://github.com/steven-ellis/sample.daytrader8
cd sample.daytrader8
----

== Login to OpenShift

Make sure you're **oc** client is logged into your target OpenShift cluter. A useful check is

[source,shell script]
----
oc get clusterversion
# or
oc whoami 
oc whoami --show-server
----

== Scripted Deployment

We now have a scripted deployment approach. This normally takes two steps

- deployment
- status check

There is still a risk that the database setup portion times out during the deployment script, in which case
follow the _**Re-populate Database**_ steps below.


[source,shell script]
----
# Make sure you're logged into the correct cluster
./deploy.sh deploy

# To confirm the environment is up correctly
./deploy.sh status

# If the status step fails, wait a couple of minutes for Kafka to complete and rerun
./deploy.sh status
----

The _status_ step should return the URL required to access the application frontend.

== Deploy Databases

On clusters where heritage application `sampledaytrader` is deployed, deploy MySQL:

[source,shell script]
----
oc apply -k k8s/db/prod

----

== Deploy Application

[source,shell script]
----
oc apply -k k8s/sampledaytrader8/prod
----

This may take a couple of minutes to deploy so monitor via

[source,shell script]
----
watch oc get pods -n daytrader -l=app=sampledaytrader8
----


[source,shell script]
----
export DAYTRADER_ROUTE="https://$(oc get route -n daytrader sampledaytrader8 -o jsonpath='{.spec.host}')"
----

== Create and Populate the DB tables

Create the application DB tables, either via the web interface

- browse to the following URL

[source,shell script]
----
echo $DAYTRADER_ROUTE/io.openliberty.sample.daytrader8/
----

- select the *_Configuration_* Tab and the *_(Re)-create_* Option

image:docs/images/buildDBTables.png[Config buildTables]

*OR* on the command line

[source,shell script]
----
curl -k -X GET "$DAYTRADER_ROUTE/io.openliberty.sample.daytrader8/config?action=buildDBTables"
----

You should get a response starting with

----
<BR>TradeBuildDB: **** Database Product detected: MySQL ****</BR>
<BR>TradeBuildDB: **** This Database is unsupported/untested use at your own risk ****</BR>

----

[source,shell script]
----
oc scale -n daytrader --replicas=0 deploy/sampledaytrader8
oc scale -n daytrader --replicas=1 deploy/sampledaytrader8
----

Allow a couple of minutes for the service to scale back up, use the "watch" command above to keep an eye on things. Then populate the tables with sample data,
either via the web interfatce

- select the *_Configuration_* Tab and the *_(Re)-populate* Option

image:docs/images/populateDBTables.png[Config populate Tables]

*OR* on the command line

[source,shell script]
----
curl -k -X GET "$DAYTRADER_ROUTE/io.openliberty.sample.daytrader8/config?action=buildDB"
----

If this works you should see a response similar to the following

----
<HEAD><BR><EM> TradeBuildDB: Building DayTrader Database...</EM><BR> This operation will take several minutes. Please wait...</HEAD>
<BODY>
<BR>TradeBuildDB: **** Creating 10000 Quotes ****</BR>
.....AERO -<BR>
----

It is critical that the above step doesn't time out. If it does time out attempt a second run, or connect to the
webapp and build the database from there to avoid timeout issues.

== Deploy Kafka

[source,shell script]
----
oc apply -k k8s/kafka/prod
----

=== Deploy Debezium KafkaConnect and MySQL KafkaConnector

[source,shell script]
----
oc apply -k k8s/debezium/prod
----

*NOTE*: This will take few mins for the Connector to be activated

Wait for the KafkaConnect `daytrader-debezium-connect` pod to be running:

[source,shell script]
----
watch oc get pods -n daytrader -l=strimzi.io/name=daytrader-debezium-connect
----

A successful KafkaConnect should show "Ready" to be "True":

[source,shell script]
----
oc get KafkaConnect  -n daytrader daytrader-debezium -ojsonpath='{.status.conditions[?(@.type=="Ready")].status}'
----

*NOTE*: It will take few seconds for the KafkaConnector to be reconciled. Wait for few mins before you run the following commands to check the status.

Check the status of the `mysql-daytrader-connector` to be ready:

[source,shell script]
----
oc get KafkaConnector -n daytrader mysql-daytrader-connector -ojsonpath='{.status.conditions[?(@.type=="Ready")].status}'
----

=== List Kafka Topics

[source,shell script]
----
./scripts/kafka-list-topics.sh daytrader
----

Will list the following topics:

[source,text]
----
__consumer_offsets
connect-cluster-configs
connect-cluster-offsets
connect-cluster-status
openshift
openshift.traderdb.accountejb
openshift.traderdb.accountprofileejb
openshift.traderdb.holdingejb
openshift.traderdb.keygenejb
openshift.traderdb.orderejb
openshift.traderdb.outboxevent
openshift.traderdb.quoteejb
schema-changes.traderdb
----

NOTE: If you don't see all the topics as listed, try restarting the debezium connector pod

[source,shell script]
----
oc scale -n daytrader --replicas=0 deploy/daytrader-debezium-connect
oc scale -n daytrader --replicas=1 deploy/daytrader-debezium-connect
----

== Access the Application

If you are running OS-X try

[source,shell script]
----
open $DAYTRADER_ROUTE/io.openliberty.sample.daytrader8/
----

Otherwise you can generate the URL to copy into your browser via

[source,shell script]
----
echo $DAYTRADER_ROUTE/io.openliberty.sample.daytrader8/
----

== Troubleshooting the Deployment

Most common issue is that the database tables don't import correctly. You can access the console via the following URL
and select the *_Configuration_* Tab and

* *_(Re)-create_* the database and/or
* *_(Re)-populate_* the database

[source,shell script]
----
echo $DAYTRADER_ROUTE/io.openliberty.sample.daytrader8
----



== Development

=== Building Debezium MySql Connector

[source,shell script]
----
cd k8s/debezium
docker build --no-cache <container-registry>/debezium-connect
docker push <container-registry>/debezium-connect
----

*NOTE*: Be sure to update the k8s/debezium/debezium-connect.yaml with an image from the build

=== Image Streams

[source,shell script]
----
oc create -f https://raw.githubusercontent.com/OpenLiberty/open-liberty-s2i/master/imagestreams/openliberty-ubi-min.json
----

=== Deploy Application

[source,shell script]
----
oc new-app openliberty:~https://github.com/kameshsampath/sample.daytrader8#sko-demo -n daytrader-dev
----

[source,shell script]
----
oc create route edge --service=sampledaytrader8 --port=9080 daytrader
export DAYTRADER_ROUTE="https://$(oc get route daytrader -ojsonpath='{.spec.host}')"
----
